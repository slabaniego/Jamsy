<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Discover Tracks</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 30%, #1e003e, #0f001f, #000000);
      overflow: hidden;
      color: white;
    }

    .container {
      max-width: 420px;
      width: 100%;
      padding: 20px;
      text-align: center;
      position: relative;
    }

    h1 {
      color: #fff;
      margin-bottom: 20px;
      font-size: 26px;
      font-weight: 600;
      text-shadow: 0 0 10px rgba(255,255,255,0.3);
    }

    .workout-badge {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(8px);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      display: inline-block;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    #trackContainer {
      position: relative;
      height: 440px;
      margin-bottom: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Cards */
    .swipe-card {
      position: absolute;
      width: 100%;
      max-width: 360px;
      height: 100%;
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      transition: transform 0.4s ease, opacity 0.4s ease;
      touch-action: none;
    }

    .swipe-card img {
      width: 100%;
      height: 260px;
      border-radius: 16px;
      object-fit: cover;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      margin-bottom: 15px;
    }

    #trackName { font-size: 20px; font-weight: 600; margin: 5px 0; }
    #artistName { font-size: 15px; color: #ddd; margin-bottom: 5px; }
    #genreText { font-size: 13px; color: #bbb; font-style: italic; margin-bottom: 15px; }

    audio {
      width: 100%;
      margin-top: auto;
      border-radius: 8px;
    }

    /* Music animation bars */
    .music-anim {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      margin-top: 10px;
      gap: 4px;
      height: 20px;
    }
    .music-anim div {
      width: 4px;
      background: #4CAF50;
      animation: bounce 0.6s infinite alternate;
    }
    .music-anim div:nth-child(2) { animation-delay: 0.1s; }
    .music-anim div:nth-child(3) { animation-delay: 0.2s; }
    .music-anim div:nth-child(4) { animation-delay: 0.3s; }
    .music-anim div:nth-child(5) { animation-delay: 0.4s; }
    @keyframes bounce {
      0% { height: 4px; }
      100% { height: 20px; }
    }

    /* Swipe badges */
    .swipe-badge {
      position: absolute;
      top: 30px;
      font-size: 32px;
      font-weight: bold;
      padding: 10px 20px;
      border: 3px solid;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      text-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    .badge-like { left: 20px; border-color: #4CAF50; color: #4CAF50; background: rgba(76,175,80,0.1); transform: rotate(-15deg);}
    .badge-skip { right: 20px; border-color: #ff5252; color: #ff5252; background: rgba(255,82,82,0.1); transform: rotate(15deg);}
    .show-badge { opacity: 1; }

    /* Buttons */
    .action-section { display: flex; flex-direction: column; align-items: center; }
    .action-buttons { display: flex; justify-content: center; gap: 40px; margin-bottom: 15px; }
    .round-btn {
      width: 70px; height: 70px; border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center;
      font-size: 28px; color: white; cursor: pointer;
      transition: transform 0.2s ease; box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    .round-btn.skip { background: radial-gradient(circle at top, #ff4d4d, #b30000); }
    .round-btn.like { background: radial-gradient(circle at top, #4CAF50, #2d7d32); }
    .round-btn:hover { transform: scale(1.1); }

    .song-counter { font-size: 15px; color: #fff; opacity: 0.8; }
    .submit-btn {
      padding: 14px 30px; background: linear-gradient(135deg, #2196F3, #0b7dda);
      color: white; border: none; border-radius: 30px; font-size: 16px;
      font-weight: 600; cursor: pointer; margin-top: 15px; transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
    }
    .submit-btn:disabled { background: #555; cursor: not-allowed; }
    .submit-btn:not(:disabled):hover { transform: translateY(-3px); }

    @media (max-width:480px) {
      .container { max-width: 95%; }
      #trackContainer { height: 380px; }
      .round-btn { width: 60px; height: 60px; font-size: 24px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üéµ Discover <span th:text="${workout}"></span> Tracks</h1>

  <div th:if="${isFamiliar}" class="workout-badge">
    Familiar Playlist ‚Ä¢ Based on your selected artists' popular tracks
  </div>
  <div th:unless="${isFamiliar}" class="workout-badge">
    Based on your selected artists ‚Ä¢ Finding hidden gems
  </div>

  <div id="trackContainer">
    <div id="trackCard" class="swipe-card">
      <img id="albumCover" src="" alt="Album Cover" />
      <h2 id="trackName"></h2>
      <p id="artistName"></p>
      <p id="genreText"></p>
      <audio id="previewPlayer" controls></audio>
      <div class="music-anim">
        <div></div><div></div><div></div><div></div><div></div>
      </div>
      <div id="likeBadge" class="swipe-badge badge-like">YAYYY</div>
      <div id="skipBadge" class="swipe-badge badge-skip">NOPES</div>
    </div>
  </div>

  <div class="action-section">
    <div class="action-buttons">
      <button class="round-btn skip" onclick="manualSwipe('skip')">‚ùå</button>
      <button class="round-btn like" onclick="manualSwipe('like')">‚ù§Ô∏è</button>
    </div>
    <div class="song-counter">
      Discovering song <span id="currentSongNumber">1</span> of <span id="totalSongs">10</span>
    </div>
    <button id="submitBtn" class="submit-btn" onclick="submitActions()" disabled>
      üëÄ View Generated Playlist
    </button>
  </div>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
let currentIndex = 0;
let likedTracks = [];
let tracks = JSON.parse(/*[[${tracksJson}]]*/ '[]');

const card = document.getElementById('trackCard');
const likeBadge = document.getElementById('likeBadge');
const skipBadge = document.getElementById('skipBadge');

function displayCurrentTrack() {
  if (!tracks || tracks.length === 0) {
    document.getElementById('trackName').textContent = "No tracks found";
    document.getElementById('artistName').textContent = "";
    document.getElementById('albumCover').src = "/images/default-cover.jpg";
    document.getElementById('previewPlayer').style.display = 'none';
    document.getElementById('submitBtn').disabled = true;
    return;
  }
  if (currentIndex >= tracks.length) { 
    endOfTracks(); 
    return; 
  }

  const track = tracks[currentIndex];
  document.getElementById("trackName").textContent = track.name || "Unknown Track";
  document.getElementById("artistName").textContent = (track.artists || []).join(", ") || "Unknown Artist";
  document.getElementById("albumCover").src = track.albumCover || "/images/default-cover.jpg";
  document.getElementById("currentSongNumber").textContent = currentIndex + 1;
  document.getElementById("totalSongs").textContent = tracks.length;

  const audioPlayer = document.getElementById("previewPlayer");
  if (track.previewUrl) { audioPlayer.src = track.previewUrl; audioPlayer.style.display='block'; }
  else { audioPlayer.pause(); audioPlayer.style.display='none'; }

  card.style.transform = "translateX(0) rotate(0)";
  card.style.opacity = "1";
}

function showBadge(type) {
  if (type==='like'){ likeBadge.classList.add('show-badge'); setTimeout(()=>likeBadge.classList.remove('show-badge'),800); }
  else { skipBadge.classList.add('show-badge'); setTimeout(()=>skipBadge.classList.remove('show-badge'),800); }
}

function handleAction(action){
  if(!tracks || currentIndex >= tracks.length) return;
  const track = tracks[currentIndex];

  const payload = { 
    action: action, 
    trackId: track.id, 
    songName: track.name,
    artist: (track.artists && track.artists[0]) ? track.artists[0] : "Unknown", 
    genres: track.genres||[]
  };

  fetch('/handle-action', {
    method:'POST', 
    headers:{'Content-Type':'application/json'}, 
    body:JSON.stringify(payload)
  })
  .then(res=>res.json())
  .then(data=>{
      if(data.success && action==='like') likedTracks.push(track);

      currentIndex++;
      if(currentIndex < tracks.length) {
        animateNextCard();
      } else {
        endOfTracks();
      }
  })
  .catch(()=>{
    currentIndex++;
    if(currentIndex < tracks.length) animateNextCard(); 
    else endOfTracks();
  });
}

function animateNextCard(){
  card.style.transition = "none";
  card.style.transform = "translateX(0) rotate(0)";
  setTimeout(() => {
    card.style.transition = "transform 0.4s ease, opacity 0.4s ease";
    displayCurrentTrack();
  }, 50);
}

function endOfTracks(){
  document.getElementById('submitBtn').disabled = false;
}

function submitActions(){
  window.location.href='/preview-playlist';
}

function manualSwipe(action){
  if(currentIndex >= tracks.length) return; // disable swipe when no more tracks

  showBadge(action);
  card.style.transition = "transform 0.3s ease, opacity 0.3s ease";
  card.style.transform = action === 'like' ? "translateX(150%) rotate(20deg)" : "translateX(-150%) rotate(-20deg)";
  card.style.opacity = "0";

  setTimeout(()=>{
    handleAction(action);
    card.style.opacity = "1";
    card.style.transform = "translateX(0) rotate(0)";
  },300);
}

/* Swipe via touch */
let startX = 0;
card.addEventListener('touchstart', e => { 
  if(currentIndex >= tracks.length) return; // disable touch swipe
  startX = e.touches[0].clientX; 
});
card.addEventListener('touchend', e => { 
  if(currentIndex >= tracks.length) return;
  const diffX = e.changedTouches[0].clientX - startX;
  if(Math.abs(diffX) > 50) { 
    manualSwipe(diffX > 0 ? 'like' : 'skip'); 
  }
});

window.addEventListener('load', displayCurrentTrack);
/*]]>*/
</script>
</body>
</html>
